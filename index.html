<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zarządzanie Drużynami - Prosty Panel</title>
<style>
  /* Reset i proste style */
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f0f4f8;
    color: #222;
  }
  header {
    background: #004aad;
    color: white;
    padding: 1em;
    text-align: center;
  }
  main {
    max-width: 900px;
    margin: 20px auto;
    background: white;
    padding: 20px;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }
  h2 {
    margin-top: 0;
    color: #004aad;
  }
  form {
    margin-bottom: 20px;
  }
  label {
    display: block;
    margin: 10px 0 5px;
  }
  input, select, button {
    padding: 8px;
    width: 100%;
    max-width: 300px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 3px;
  }
  button {
    background: #004aad;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover {
    background: #003580;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  ul li {
    padding: 8px;
    background: #e3e9f3;
    margin-bottom: 6px;
    border-radius: 3px;
    cursor: pointer;
  }
  ul li.selected {
    background: #004aad;
    color: white;
  }
  #playersBox {
    margin-top: 20px;
  }
  #matchesTable {
    width: 100%;
    border-collapse: collapse;
  }
  #matchesTable th, #matchesTable td {
    border: 1px solid #ddd;
    padding: 8px;
  }
  #matchesTable th {
    background-color: #004aad;
    color: white;
  }
  #errorMsg {
    color: red;
    margin: 10px 0;
  }
  #logoutBtn {
    background: #cc0000;
    margin-bottom: 20px;
    width: auto;
    padding: 8px 16px;
  }
  #logoutBtn:hover {
    background: #990000;
  }
  @media (max-width: 600px) {
    main {
      margin: 10px;
      padding: 10px;
    }
    input, select, button {
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<header><h1>Zarządzanie Drużynami</h1></header>

<main>
  <!-- LOGOWANIE -->
  <section id="loginSection">
    <h2>Logowanie</h2>
    <form id="loginForm">
      <label for="emailInput">Email</label>
      <input id="emailInput" type="email" required />
      <label for="passwordInput">Hasło</label>
      <input id="passwordInput" type="password" required />
      <button type="submit">Zaloguj się</button>
    </form>
    <div id="errorMsg"></div>
  </section>

  <!-- APLIKACJA -->
  <section id="appSection" style="display:none;">
    <button id="logoutBtn">Wyloguj się</button>

    <!-- Drużyny -->
    <section>
      <h2>Drużyny</h2>
      <form id="teamForm">
        <input id="teamNameInput" placeholder="Nazwa drużyny" required />
        <button type="submit">Dodaj drużynę</button>
      </form>
      <ul id="teamsList"></ul>
    </section>

    <!-- Zawodnicy -->
    <section id="playersBox" style="display:none;">
      <h2>Zawodnicy drużyny: <span id="currentTeamName"></span></h2>
      <form id="playerForm">
        <input id="playerNameInput" placeholder="Imię i nazwisko zawodnika" required />
        <button type="submit">Dodaj zawodnika</button>
      </form>
      <ul id="playersList"></ul>
      <button id="backToTeamsBtn">Wróć do drużyn</button>
    </section>

    <!-- Mecze -->
    <section style="margin-top:30px;">
      <h2>Dodaj mecz</h2>
      <form id="matchForm">
        <label for="matchDate">Data meczu</label>
        <input id="matchDate" type="date" required />
        <label for="matchTeamSelect">Drużyna</label>
        <select id="matchTeamSelect" required>
          <option value="">-- wybierz drużynę --</option>
        </select>
        <label for="matchOpponentInput">Przeciwnik</label>
        <input id="matchOpponentInput" type="text" required />
        <label for="matchScoreInput">Wynik (np. 2:1)</label>
        <input id="matchScoreInput" required pattern="^\d+:\d+$" title="Format: liczba:liczba" />
        <button type="submit">Dodaj mecz</button>
      </form>

      <h3>Lista meczów</h3>
      <table id="matchesTable">
        <thead>
          <tr><th>Data</th><th>Drużyna</th><th>Przeciwnik</th><th>Wynik</th><th>Akcje</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Wykres -->
    <section style="margin-top:30px;">
      <h2>Wykres postępu zawodników</h2>
      <label for="chartTeamSelect">Wybierz drużynę:</label>
      <select id="chartTeamSelect">
        <option value="">-- wybierz drużynę --</option>
      </select>
      <canvas id="progressChart" width="600" height="350" style="max-width:100%;"></canvas>
    </section>
  </section>
</main>

<!-- Firebase i Chart.js -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Konfiguracja Firebase - tu wstaw swoje dane!
  const firebaseConfig = {
    apiKey: "AIzaSyAWXiBO5-woCCEqCBc2rfOIo1RhUUtevzU",
    authDomain: "jaguar-analityka.firebaseapp.com",
    databaseURL: "https://jaguar-analityka-default-rtdb.firebaseio.com",
    projectId: "jaguar-analityka",
    storageBucket: "jaguar-analityka.firebasestorage.app",
    messagingSenderId: "163915747034",
    appId: "1:163915747034:web:8c0311eaaa4ed792b25fe3",
    measurementId: "G-T3C1M10SM6"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Elementy DOM
  const loginSection = document.getElementById('loginSection');
  const appSection = document.getElementById('appSection');
  const errorMsg = document.getElementById('errorMsg');
  const logoutBtn = document.getElementById('logoutBtn');

  const loginForm = document.getElementById('loginForm');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');

  const teamsList = document.getElementById('teamsList');
  const teamForm = document.getElementById('teamForm');
  const teamNameInput = document.getElementById('teamNameInput');

  const playersBox = document.getElementById('playersBox');
  const playersList = document.getElementById('playersList');
  const playerForm = document.getElementById('playerForm');
  const playerNameInput = document.getElementById('playerNameInput');
  const currentTeamName = document.getElementById('currentTeamName');
  const backToTeamsBtn = document.getElementById('backToTeamsBtn');

  const matchForm = document.getElementById('matchForm');
  const matchDateInput = document.getElementById('matchDate');
  const matchTeamSelect = document.getElementById('matchTeamSelect');
  const matchOpponentInput = document.getElementById('matchOpponentInput');
  const matchScoreInput = document.getElementById('matchScoreInput');
  const matchesTableBody = document.querySelector('#matchesTable tbody');

  const chartTeamSelect = document.getElementById('chartTeamSelect');
  const progressChartCtx = document.getElementById('progressChart').getContext('2d');
  let progressChart = null;

  // Stan aplikacji
  let teamsData = {};
  let playersData = {};
  let matchesData = {};
  let currentTeamId = null;

  // Autoryzacja
  auth.onAuthStateChanged(user => {
    if (user) {
      errorMsg.textContent = '';
      loginSection.style.display = 'none';
      appSection.style.display = 'block';
      loadTeams();
      loadMatches();
      clearPlayersList();
      clearChart();
    } else {
      loginSection.style.display = 'block';
      appSection.style.display = 'none';
      clearAll();
    }
  });

  // Logowanie
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    errorMsg.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      errorMsg.textContent = 'Podaj email i hasło';
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .then(() => loginForm.reset())
      .catch(err => errorMsg.textContent = 'Błąd logowania: ' + err.message);
  });

  logoutBtn.addEventListener('click', () => auth.signOut());

  // Drużyny
  function loadTeams() {
    db.ref('teams').on('value', snapshot => {
      teamsData = snapshot.val() || {};
      renderTeamsList();
      populateTeamSelectors();
    });
  }

  function renderTeamsList() {
    teamsList.innerHTML = '';
    for (const id in teamsData) {
      const li = document.createElement('li');
      li.textContent = teamsData[id].name;
      li.dataset.id = id;
      li.className = (id === currentTeamId) ? 'selected' : '';
      li.onclick = () => selectTeam(id);
      teamsList.appendChild(li);
    }
  }

  teamForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = teamNameInput.value.trim();
    if (!name) {
      alert('Podaj nazwę drużyny');
      return;
    }
    db.ref('teams').push({ name })
      .then(() => teamNameInput.value = '')
      .catch(err => alert('Błąd dodawania drużyny: ' + err.message));
  });

  function selectTeam(id) {
    currentTeamId = id;
    currentTeamName.textContent = teamsData[id].name;
    playersBox.style.display = 'block';
    loadPlayers(id);
    renderTeamsList();
  }

  backToTeamsBtn.onclick = () => {
    currentTeamId = null;
    playersBox.style.display = 'none';
    renderTeamsList();
  };

  // Zawodnicy
  function loadPlayers(teamId) {
    db.ref('players/' + teamId).on('value', snapshot => {
      playersData = snapshot.val() || {};
      renderPlayersList();
    });
  }

  function renderPlayersList() {
    playersList.innerHTML = '';
    for (const id in playersData) {
      const li = document.createElement('li');
      li.textContent = playersData[id].name;
      li.dataset.id = id;
      li.onclick = () => showPlayerDetails(id);
      playersList.appendChild(li);
    }
  }

  playerForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentTeamId) {
      alert('Wybierz drużynę najpierw');
      return;
    }
    const name = playerNameInput.value.trim();
    if (!name) {
      alert('Podaj imię i nazwisko zawodnika');
      return;
    }
    db.ref('players/' + currentTeamId).push({
      name,
      trainingScores: {},
      matchScores: {}
    }).then(() => playerNameInput.value = '')
      .catch(err => alert('Błąd dodawania zawodnika: ' + err.message));
  });

  function showPlayerDetails(playerId) {
    const player = playersData[playerId];
    if (!player) return;
    let trainingAvg = calcAverage(player.trainingScores);
    let matchAvg = calcAverage(player.matchScores);
    alert(`Zawodnik: ${player.name}\nŚrednia ocena treningu: ${trainingAvg}\nŚrednia ocena meczu: ${matchAvg}\n\nObsługa dodawania ocen dostępna w kolejnej wersji.`);
  }

  function calcAverage(scoresObj) {
    if (!scoresObj) return 0;
    const values = Object.values(scoresObj);
    if (values.length === 0) return 0;
    const sum = values.reduce((a,b) => a + b, 0);
    return (sum / values.length).toFixed(2);
  }

  function clearPlayersList() {
    playersList.innerHTML = '';
    playersBox.style.display = 'none';
    currentTeamName.textContent = '';
  }

  // Mecze
  function loadMatches() {
    db.ref('matches').on('value', snapshot => {
      matchesData = snapshot.val() || {};
      renderMatchesList();
    });
  }

  function renderMatchesList() {
    matchesTableBody.innerHTML = '';
    for (const id in matchesData) {
      const m = matchesData[id];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.date}</td>
        <td>${teamsData[m.teamId] ? teamsData[m.teamId].name : 'Brak drużyny'}</td>
        <td>${m.opponent}</td>
        <td>${m.score}</td>
        <td><button data-id="${id}" class="delMatchBtn">Usuń</button></td>
      `;
      matchesTableBody.appendChild(tr);
    }
    // Obsługa usuwania
    document.querySelectorAll('.delMatchBtn').forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.id;
        if (confirm('Na pewno usunąć ten mecz?')) {
          db.ref('matches/' + id).remove();
        }
      };
    });
  }

  matchForm.addEventListener('submit', e => {
    e.preventDefault();
    const date = matchDateInput.value;
    const teamId = matchTeamSelect.value;
    const opponent = matchOpponentInput.value.trim();
    const score = matchScoreInput.value.trim();

    if (!date || !teamId || !opponent || !score) {
      alert('Wypełnij wszystkie pola meczu');
      return;
    }
    // Dodaj do bazy
    db.ref('matches').push({ date, teamId, opponent, score })
      .then(() => {
        matchForm.reset();
      })
      .catch(err => alert('Błąd dodawania meczu: ' + err.message));
  });

  function populateTeamSelectors() {
    // Do meczu i wykresu
    const options = Object.entries(teamsData).map(([id, t]) => `<option value="${id}">${t.name}</option>`).join('');
    matchTeamSelect.innerHTML = `<option value="">-- wybierz drużynę --</option>${options}`;
    chartTeamSelect.innerHTML = `<option value="">-- wybierz drużynę --</option>${options}`;
  }

  // Wykres
  chartTeamSelect.addEventListener('change', () => {
    const teamId = chartTeamSelect.value;
    if (!teamId) {
      clearChart();
      return;
    }
    drawChart(teamId);
  });

  function drawChart(teamId) {
    // Pobierz zawodników z ocenami (tu uproszczone, liczymy średnie z treningów i meczów)
    db.ref('players/' + teamId).once('value').then(snapshot => {
      const players = snapshot.val() || {};
      const labels = [];
      const trainingAvgs = [];
      const matchAvgs = [];
      for (const pid in players) {
        const p = players[pid];
        labels.push(p.name);
        trainingAvgs.push(calcAverage(p.trainingScores));
        matchAvgs.push(calcAverage(p.matchScores));
      }
      if (progressChart) progressChart.destroy();
      progressChart = new Chart(progressChartCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Średnia ocena treningu',
              backgroundColor: 'rgba(0, 74, 173, 0.7)',
              data: trainingAvgs
            },
            {
              label: 'Średnia ocena meczu',
              backgroundColor: 'rgba(0, 128, 0, 0.7)',
              data: matchAvgs
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 10 }
          }
        }
      });
    });
  }

  function clearChart() {
    if (progressChart) {
      progressChart.destroy();
      progressChart = null;
    }
  }

  function clearAll() {
    clearPlayersList();
    teamsList.innerHTML = '';
    matchesTableBody.innerHTML = '';
    matchTeamSelect.innerHTML = '<option value="">-- wybierz drużynę --</option>';
    chartTeamSelect.innerHTML = '<option value="">-- wybierz drużynę --</option>';
    clearChart();
  }

</script>

</body>
</html>

