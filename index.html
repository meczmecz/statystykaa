<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>System Analizy Meczy - Jaguar</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9; }
  nav { margin-bottom: 20px; }
  nav button { margin-right: 10px; padding: 10px 15px; cursor: pointer; }
  nav button.active { background-color: #007bff; color: white; border: none; }
  section { display: none; }
  section.active { display: block; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc; }
  label { display: block; margin-top: 10px; }
  input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  .btn { padding: 6px 12px; cursor: pointer; margin-right: 5px; }
  .btn-edit { background: #ffc107; border: none; color: black; }
  .btn-delete { background: #dc3545; border: none; color: white; }
  .btn-add { background: #28a745; border: none; color: white; margin-top: 10px; }
  #loginForm, #logoutBtn { margin-bottom: 20px; }
  #logoutBtn { display: none; padding: 8px 15px; background: #dc3545; color: white; border: none; cursor: pointer; }
  .error { color: red; }
</style>
</head>
<body>

<h1>System Analizy Meczy - Jaguar</h1>

<div id="authSection">
  <form id="loginForm">
    <label>Email:<input type="email" id="email" required /></label>
    <label>Hasło:<input type="password" id="password" required /></label>
    <button type="submit">Zaloguj się</button>
  </form>
  <button id="logoutBtn">Wyloguj się</button>
  <div id="authMessage" class="error"></div>
</div>

<nav>
  <button data-tab="matches" class="active">Analiza meczy</button>
  <button data-tab="teams">Drużyny</button>
  <button data-tab="players">Zawodnicy i oceny</button>
</nav>

<section id="matches" class="active">
  <h2>Analiza meczy</h2>
  <form id="matchForm">
    <label>Data meczu:<input type="date" id="matchDate" required /></label>
    <label>Wynik meczu:<input type="text" id="matchScore" placeholder="np. 3:2" required /></label>
    <label>Strzelcy bramek drużyny Jaguar (oddziel przecinkiem):<textarea id="scorersJaguar" rows="2" placeholder="np. Kowalski, Nowak"></textarea></label>
    <label>Strzelcy bramek drużyny przeciwnika (oddziel przecinkiem):<textarea id="scorersOpponent" rows="2"></textarea></label>
    <label>Najlepszy zawodnik meczu:<input type="text" id="bestPlayer" /></label>
    <label>3 najlepszych zawodników Jaguar (oddziel przecinkiem):<input type="text" id="topPlayersJaguar" /></label>
    <label>3 najlepszych zawodników przeciwnika (oddziel przecinkiem):<input type="text" id="topPlayersOpponent" /></label>
    <h3>Opis i ocena zawodników (opcjonalne):</h3>
    <div id="playersDetailsContainer"></div>
    <button type="button" id="addPlayerDetailBtn" class="btn btn-add">Dodaj zawodnika</button>
    <button type="submit" class="btn btn-add">Zapisz mecz</button>
  </form>
  <h3>Lista meczy</h3>
  <input type="text" id="searchMatchInput" placeholder="Szukaj po dacie lub wyniku" />
  <table id="matchesTable">
    <thead>
      <tr><th>Data</th><th>Wynik</th><th>Strzelcy Jaguar</th><th>Strzelcy Przeciwnik</th><th>Najlepszy zawodnik</th><th>Akcje</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="teams">
  <h2>Drużyny</h2>
  <form id="teamForm">
    <label>Nazwa drużyny:<input type="text" id="teamName" required /></label>
    <button type="submit" class="btn btn-add">Dodaj drużynę</button>
  </form>
  <h3>Lista drużyn</h3>
  <table id="teamsTable">
    <thead>
      <tr><th>Nazwa drużyny</th><th>Zawodnicy</th><th>Akcje</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="players">
  <h2>Zawodnicy i oceny</h2>
  <form id="ratingForm">
    <label>Wybierz drużynę:
      <select id="selectTeam" required>
        <option value="">-- wybierz --</option>
      </select>
    </label>
    <label>Wybierz zawodnika:
      <select id="selectPlayer" required>
        <option value="">-- wybierz --</option>
      </select>
    </label>
    <label>Data oceny:<input type="date" id="ratingDate" required /></label>
    <label>Ocena treningu (1-5):<input type="number" id="trainingRating" min="1" max="5" required /></label>
    <label>Ocena meczu (1-5):<input type="number" id="matchRating" min="1" max="5" required /></label>
    <label>Czas na boisku (minuty):<input type="number" id="playTime" min="0" required /></label>
    <button type="submit" class="btn btn-add">Dodaj ocenę</button>
  </form>
  <button id="showChartsBtn" class="btn btn-add" disabled>Pokaż wykresy</button>
  <canvas id="chartTraining" width="600" height="200"></canvas>
  <canvas id="chartMatch" width="600" height="200"></canvas>
</section>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// TODO: tutaj wklej swoją konfigurację Firebase z panelu Firebase:
const firebaseConfig = {
  apiKey: "TWOJE_API_KEY",
  authDomain: "TWOJ_PROJEKT.firebaseapp.com",
  databaseURL: "https://TWOJ_PROJEKT.firebaseio.com",
  projectId: "TWOJ_PROJEKT",
  storageBucket: "TWOJ_PROJEKT.appspot.com",
  messagingSenderId: "NUMER",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;

// Obsługa logowania
const loginForm = document.getElementById('loginForm');
const logoutBtn = document.getElementById('logoutBtn');
const authMessage = document.getElementById('authMessage');

loginForm.addEventListener('submit', e => {
  e.preventDefault();
  const email = loginForm.email.value;
  const password = loginForm.password.value;
  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      authMessage.textContent = '';
    })
    .catch(e => {
      authMessage.textContent = 'Błąd logowania: ' + e.message;
    });
});

logoutBtn.addEventListener('click', () => {
  auth.signOut();
});

auth.onAuthStateChanged(user => {
  currentUser = user;
  if (user) {
    loginForm.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    loadTeams();
    loadMatches();
    setupTabs();
  } else {
    loginForm.style.display = 'block';
    logoutBtn.style.display = 'none';
  }
});

// Nawigacja zakładek
const navButtons = document.querySelectorAll('nav button');
const sections = document.querySelectorAll('section');

function setupTabs() {
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      navButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      sections.forEach(s => s.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
    });
  });
}

// Ładowanie drużyn do select i tabeli
const selectTeam = document.getElementById('selectTeam');
const teamsTableBody = document.querySelector('#teamsTable tbody');
const teamForm = document.getElementById('teamForm');

function loadTeams() {
  selectTeam.innerHTML = '<option value="">-- wybierz --</option>';
  teamsTableBody.innerHTML = '';
  db.ref('teams').on('value', snapshot => {
    teamsTableBody.innerHTML = '';
    selectTeam.innerHTML = '<option value="">-- wybierz --</option>';
    snapshot.forEach(child => {
      const team = child.val();
      const teamId = child.key;
      // do selecta
      const opt = document.createElement('option');
      opt.value = teamId;
      opt.textContent = team.name;
      selectTeam.appendChild(opt);
      // do tabeli
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${team.name}</td>
        <td>${team.players ? team.players.map(p => p.name).join(', ') : ''}</td>
        <td>
          <button class="btn btn-edit" data-id="${teamId}" onclick="editTeam('${teamId}')">Edytuj</button>
          <button class="btn btn-delete" data-id="${teamId}" onclick="deleteTeam('${teamId}')">Usuń</button>
        </td>`;
      teamsTableBody.appendChild(tr);
    });
  });
}

// Dodawanie drużyny
teamForm.addEventListener('submit', e => {
  e.preventDefault();
  const name = teamForm.teamName.value.trim();
  if (!name) return alert('Podaj nazwę drużyny');
  db.ref('teams').push({ name, players: [] })
    .then(() => {
      teamForm.reset();
      alert('Drużyna dodana');
    })
    .catch(e => alert('Błąd dodawania: ' + e.message));
});

// Edycja drużyny (np. nazwy i zawodników) - proste wyświetlenie alertu, potem rozbudujemy
window.editTeam = function(teamId) {
  const teamRef = db.ref('teams/' + teamId);
  teamRef.once('value').then(snapshot => {
    const team = snapshot.val();
    const newName = prompt('Edytuj nazwę drużyny', team.name);
    if (newName && newName.trim() !== '') {
      teamRef.update({ name: newName.trim() });
    }
  });
};

// Usuwanie drużyny
window.deleteTeam = function(teamId) {
  if (confirm('Na pewno chcesz usunąć tę drużynę?')) {
    db.ref('teams/' + teamId).remove();
  }
};

// Ładowanie meczy i tabela
const matchesTableBody = document.querySelector('#matchesTable tbody');
const matchForm = document.getElementById('matchForm');
const searchMatchInput = document.getElementById('searchMatchInput');

function loadMatches() {
  db.ref('matches').on('value', snapshot => {
    displayMatches(snapshot);
  });
}

function displayMatches(snapshot) {
  matchesTableBody.innerHTML = '';
  const filter = searchMatchInput.value.toLowerCase();
  snapshot.forEach(child => {
    const match = child.val();
    const id = child.key;
    if (match.date.toLowerCase().includes(filter) || (match.score && match.score.toLowerCase().includes(filter))) {
      const scorersJaguar = (match.scorers && match.scorers.team1) ? match.scorers.team1.join(', ') : '';
      const scorersOpponent = (match.scorers && match.scorers.team2) ? match.scorers.team2.join(', ') : '';
      matchesTableBody.innerHTML += `<tr>
        <td>${match.date}</td>
        <td>${match.score || ''}</td>
        <td>${scorersJaguar}</td>
        <td>${scorersOpponent}</td>
        <td>${match.bestPlayer || ''}</td>
        <td>
          <button class="btn btn-edit" onclick="editMatch('${id}')">Edytuj</button>
          <button class="btn btn-delete" onclick="deleteMatch('${id}')">Usuń</button>
        </td>
      </tr>`;
    }
  });
}

searchMatchInput.addEventListener('input', () => {
  loadMatches();
});

// Dodawanie meczu
matchForm.addEventListener('submit', e => {
  e.preventDefault();

  const date = matchForm.matchDate.value;
  const score = matchForm.matchScore.value.trim();
  const scorersJaguar = matchForm.scorersJaguar.value.split(',').map(s => s.trim()).filter(s => s);
  const scorersOpponent = matchForm.scorersOpponent.value.split(',').map(s => s.trim()).filter(s => s);
  const bestPlayer = matchForm.bestPlayer.value.trim();
  const topPlayersJaguar = matchForm.topPlayersJaguar.value.split(',').map(s => s.trim()).filter(s => s);
  const topPlayersOpponent = matchForm.topPlayersOpponent.value.split(',').map(s => s.trim()).filter(s => s);

  // Pobierz opisy i oceny zawodników
  const playersDetailsInputs = document.querySelectorAll('.player-detail');
  const playersDetails = {};
  playersDetailsInputs.forEach(div => {
    const name = div.querySelector('.playerName').value.trim();
    const description = div.querySelector('.playerDescription').value.trim();
    const rating = div.querySelector('.playerRating').value.trim();
    if (name) playersDetails[name] = { description, rating };
  });

  if (!date || !score) return alert('Wypełnij datę i wynik meczu');

  const newMatch = {
    date,
    score,
    scorers: { team1: scorersJaguar, team2: scorersOpponent },
    bestPlayer,
    topPlayers: { team1: topPlayersJaguar, team2: topPlayersOpponent },
    playersDetails
  };

  db.ref('matches').push(newMatch)
    .then(() => {
      alert('Mecz dodany');
      matchForm.reset();
      clearPlayersDetails();
    })
    .catch(e => alert('Błąd zapisu meczu: ' + e.message));
});

function clearPlayersDetails() {
  document.getElementById('playersDetailsContainer').innerHTML = '';
}

// Dodawanie pola dla opisu zawodnika w meczu
const addPlayerDetailBtn = document.getElementById('addPlayerDetailBtn');
const playersDetailsContainer = document.getElementById('playersDetailsContainer');

addPlayerDetailBtn.addEventListener('click', () => {
  const div = document.createElement('div');
  div.classList.add('player-detail');
  div.innerHTML = `
    <label>Nazwa zawodnika: <input type="text" class="playerName" required></label>
    <label>Opis: <textarea class="playerDescription" rows="2"></textarea></label>
    <label>Ocena (1-5): <input type="number" class="playerRating" min="1" max="5"></label>
    <button type="button" onclick="this.parentNode.remove()">Usuń</button>
  `;
  playersDetailsContainer.appendChild(div);
});

// Edycja i usuwanie meczy
window.editMatch = function(id) {
  db.ref('matches/' + id).once('value').then(snapshot => {
    const match = snapshot.val();
    if (!match) return alert('Mecz nie znaleziony');
    matchForm.matchDate.value = match.date;
    matchForm.matchScore.value = match.score || '';
    matchForm.scorersJaguar.value = (match.scorers && match.scorers.team1) ? match.scorers.team1.join(', ') : '';
    matchForm.scorersOpponent.value = (match.scorers && match.scorers.team2) ? match.scorers.team2.join(', ') : '';
    matchForm.bestPlayer.value = match.bestPlayer || '';
    matchForm.topPlayersJaguar.value = (match.topPlayers && match.topPlayers.team1) ? match.topPlayers.team1.join(', ') : '';
    matchForm.topPlayersOpponent.value = (match.topPlayers && match.topPlayers.team2) ? match.topPlayers.team2.join(', ') : '';

    // Wyczyść stare i wstaw nowe opisy zawodników
    clearPlayersDetails();
    if (match.playersDetails) {
      for (const playerName in match.playersDetails) {
        const data = match.playersDetails[playerName];
        const div = document.createElement('div');
        div.classList.add('player-detail');
        div.innerHTML = `
          <label>Nazwa zawodnika: <input type="text" class="playerName" value="${playerName}" required></label>
          <label>Opis: <textarea class="playerDescription" rows="2">${data.description || ''}</textarea></label>
          <label>Ocena (1-5): <input type="number" class="playerRating" min="1" max="5" value="${data.rating || ''}"></label>
          <button type="button" onclick="this.parentNode.remove()">Usuń</button>
        `;
        playersDetailsContainer.appendChild(div);
      }
    }

    // Zamiast tworzyć nowy wpis, nadpisujemy istniejący po zapisie
    matchForm.dataset.editId = id;
  });
};

window.deleteMatch = function(id) {
  if (confirm('Na pewno chcesz usunąć ten mecz?')) {
    db.ref('matches/' + id).remove();
  }
};

matchForm.addEventListener('submit', e => {
  e.preventDefault();

  const id = matchForm.dataset.editId;
  if (!id) return; // to normalne dodanie, nie edycja

  const date = matchForm.matchDate.value;
  const score = matchForm.matchScore.value.trim();
  const scorersJaguar = matchForm.scorersJaguar.value.split(',').map(s => s.trim()).filter(s => s);
  const scorersOpponent = matchForm.scorersOpponent.value.split(',').map(s => s.trim()).filter(s => s);
  const bestPlayer = matchForm.bestPlayer.value.trim();
  const topPlayersJaguar = matchForm.topPlayersJaguar.value.split(',').map(s => s.trim()).filter(s => s);
  const topPlayersOpponent = matchForm.topPlayersOpponent.value.split(',').map(s => s.trim()).filter(s => s);

  const playersDetailsInputs = document.querySelectorAll('.player-detail');
  const playersDetails = {};
  playersDetailsInputs.forEach(div => {
    const name = div.querySelector('.playerName').value.trim();
    const description = div.querySelector('.playerDescription').value.trim();
    const rating = div.querySelector('.playerRating').value.trim();
    if (name) playersDetails[name] = { description, rating };
  });

  if (!date || !score) return alert('Wypełnij datę i wynik meczu');

  const updatedMatch = {
    date,
    score,
    scorers: { team1: scorersJaguar, team2: scorersOpponent },
    bestPlayer,
    topPlayers: { team1: topPlayersJaguar, team2: topPlayersOpponent },
    playersDetails
  };

  db.ref('matches/' + id).set(updatedMatch)
    .then(() => {
      alert('Mecz zaktualizowany');
      matchForm.reset();
      clearPlayersDetails();
      delete matchForm.dataset.editId;
    })
    .catch(e => alert('Błąd zapisu meczu: ' + e.message));
});

// Ładowanie zawodników po wyborze drużyny w zakładce "Zawodnicy i oceny"
const selectPlayer = document.getElementById('selectPlayer');

selectTeam.addEventListener('change', () => {
  selectPlayer.innerHTML = '<option value="">-- wybierz --</option>';
  const teamId = selectTeam.value;
  if (!teamId) return;
  db.ref('teams/' + teamId + '/players').once('value').then(snapshot => {
    snapshot.forEach(child => {
      const player = child.val();
      const opt = document.createElement('option');
      opt.value = player.name;
      opt.textContent = player.name;
      selectPlayer.appendChild(opt);
    });
  });
});

// Dodawanie oceny zawodnika
const ratingForm = document.getElementById('ratingForm');
const showChartsBtn = document.getElementById('showChartsBtn');
const chartTraining = document.getElementById('chartTraining').getContext('2d');
const chartMatch = document.getElementById('chartMatch').getContext('2d');

let chartTrainingInstance = null;
let chartMatchInstance = null;

ratingForm.addEventListener('submit', e => {
  e.preventDefault();

  const teamId = selectTeam.value;
  const playerName = selectPlayer.value;
  const date = ratingForm.ratingDate.value;
  const trainingRating = parseInt(ratingForm.trainingRating.value);
  const matchRating = parseInt(ratingForm.matchRating.value);
  const playTime = parseInt(ratingForm.playTime.value);

  if (!teamId || !playerName || !date || !trainingRating || !matchRating) {
    return alert('Wypełnij wszystkie pola');
  }

  const newRating = {
    teamId,
    playerName,
    date,
    trainingRating,
    matchRating,
    playTime,
    createdBy: currentUser.uid,
    timestamp: Date.now()
  };

  db.ref('ratings').push(newRating)
    .then(() => {
      alert('Ocena dodana');
      ratingForm.reset();
      showChartsBtn.disabled = false;
    })
    .catch(e => alert('Błąd zapisu oceny: ' + e.message));
});

// Pokazywanie wykresów progresu ocen
showChartsBtn.addEventListener('click', () => {
  const teamId = selectTeam.value;
  const playerName = selectPlayer.value;
  if (!teamId || !playerName) return alert('Wybierz drużynę i zawodnika');

  db.ref('ratings')
    .orderByChild('playerName')
    .equalTo(playerName)
    .once('value')
    .then(snapshot => {
      const data = [];
      snapshot.forEach(child => {
        const rating = child.val();
        if (rating.teamId === teamId) {
          data.push(rating);
        }
      });

      // Sortuj po dacie
      data.sort((a, b) => new Date(a.date) - new Date(b.date));

      const labels = data.map(d => d.date);
      const trainingData = data.map(d => d.trainingRating);
      const matchData = data.map(d => d.matchRating);

      if (chartTrainingInstance) chartTrainingInstance.destroy();
      if (chartMatchInstance) chartMatchInstance.destroy();

      chartTrainingInstance = new Chart(chartTraining, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Ocena treningu',
            data: trainingData,
            borderColor: 'blue',
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          scales: { y: { min: 1, max: 5, ticks: { stepSize: 1 } } }
        }
      });

      chartMatchInstance = new Chart(chartMatch, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Ocena meczu',
            data: matchData,
            borderColor: 'green',
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          scales: { y: { min: 1, max: 5, ticks: { stepSize: 1 } } }
        }
      });

    });
});

</script>

</body>
</html>
