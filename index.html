<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jaguar Analityka - zarządzanie drużynami i meczami</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f7fa; }
  header { background: #003366; color: white; padding: 15px; text-align: center; font-size: 1.5em; font-weight: bold; }
  main { max-width: 1000px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #aaa; }
  section { margin-bottom: 30px; }
  h2 { border-bottom: 2px solid #003366; padding-bottom: 5px; margin-bottom: 15px; color: #003366; }
  label { display: block; margin: 8px 0 4px; }
  input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea, input[type="date"] {
    width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid #bbb; font-size: 1em;
  }
  button { background: #003366; color: white; border: none; padding: 8px 16px; margin-top: 12px; cursor: pointer; border-radius: 4px; font-weight: bold; transition: background-color 0.3s ease; }
  button:hover { background: #0055aa; }
  nav { margin-bottom: 20px; text-align: center; }
  nav button { margin: 0 8px; padding: 10px 20px; font-size: 1em; border-radius: 4px; border: 2px solid #003366; background: white; color: #003366; cursor: pointer; font-weight: bold; }
  nav button.active, nav button:hover { background: #003366; color: white; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  table th { background: #003366; color: white; }
  .hidden { display: none; }
  #playersList li { cursor: pointer; padding: 4px 8px; border-bottom: 1px solid #eee; }
  #playersList li:hover { background: #cce4ff; }
  #playerDetails { margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px; }
  #charts { display: flex; gap: 20px; flex-wrap: wrap; }
  canvas { background: #fff; border: 1px solid #ccc; border-radius: 6px; }
  #authMessage { color: red; margin-top: 10px; text-align: center; }
</style>
</head>
<body>

<header>Jaguar Analityka - Zarządzanie drużynami i meczami</header>
<main>
  <!-- LOGOWANIE -->
  <section id="loginSection">
    <h2>Logowanie</h2>
    <form id="loginForm">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required placeholder="Twój email" />
      <label for="password">Hasło:</label>
      <input type="password" id="password" name="password" required placeholder="Twoje hasło" />
      <button type="submit">Zaloguj się</button>
    </form>
    <div id="authMessage"></div>
  </section>

  <nav id="mainNav" class="hidden">
    <button data-tab="teams" class="active">Drużyny</button>
    <button data-tab="matches">Mecze</button>
    <button data-tab="progress">Postęp</button>
    <button id="logoutBtn">Wyloguj</button>
  </nav>

  <!-- DRUŻYNY -->
  <section id="teams" class="hidden">
    <h2>Drużyny i zawodnicy</h2>
    <form id="teamForm">
      <label for="teamName">Nazwa drużyny:</label>
      <input type="text" id="teamName" name="teamName" required placeholder="Wpisz nazwę drużyny" />
      <button type="submit">Dodaj drużynę</button>
    </form>
    <ul id="teamsList"></ul>
    <div id="teamDetails" class="hidden" style="margin-top:20px;">
      <h3>Drużyna: <span id="teamNameDisplay"></span></h3>
      <form id="playerForm">
        <label for="playerNameInput">Dodaj zawodnika:</label>
        <input type="text" id="playerNameInput" name="playerNameInput" required placeholder="Imię i nazwisko zawodnika" />
        <button type="submit">Dodaj zawodnika</button>
      </form>
      <ul id="playersList"></ul>
      <div id="playerDetails" class="hidden">
        <h4>Szczegóły zawodnika: <span id="playerDetailName"></span></h4>
        <form id="trainingScoreForm">
          <label>Dodaj ocenę treningu (0-10):</label>
          <input type="number" id="trainingScoreInput" min="0" max="10" step="0.1" required />
          <button type="submit">Dodaj ocenę treningu</button>
        </form>
        <form id="matchScoreForm">
          <label>Dodaj ocenę meczu (0-10):</label>
          <input type="number" id="matchScoreInputPlayer" min="0" max="10" step="0.1" required />
          <button type="submit">Dodaj ocenę meczu</button>
        </form>
        <button id="closePlayerDetailsBtn">Zamknij szczegóły zawodnika</button>
      </div>
    </div>
  </section>

  <!-- MECZE -->
  <section id="matches" class="hidden">
    <h2>Dodaj nowy mecz</h2>
    <form id="matchForm">
      <label for="matchDate">Data meczu:</label>
      <input type="date" id="matchDate" name="matchDate" required />
      <label for="teamASelect">Drużyna A (Jaguar):</label>
      <select id="teamASelect" name="teamASelect" required></select>
      <label for="teamBName">Drużyna B (nazwa):</label>
      <input type="text" id="teamBName" name="teamBName" required placeholder="Wpisz nazwę drużyny przeciwnej" />
      <label for="matchScore">Wynik (np. 3:1):</label>
      <input type="text" id="matchScore" name="matchScore" placeholder="np. 3:1" required />

      <label>Najlepsi zawodnicy Jaguara:</label>
      <div id="jaguarBestPlayers"></div>
      <div id="jaguarPlayersRatings"></div>

      <label>Najlepsi zawodnicy drużyny przeciwnej:</label>
      <input type="text" name="opponentBestPlayer1" placeholder="Zawodnik 1" required />
      <input type="text" name="opponentBestPlayer2" placeholder="Zawodnik 2" required />
      <input type="text" name="opponentBestPlayer3" placeholder="Zawodnik 3" required />
      <div id="opponentPlayersRatings"></div>

      <label for="matchRating">Ocena meczu (opcjonalnie):</label>
      <input type="number" id="matchRating" name="matchRating" min="0" max="10" step="0.1" />

      <button type="submit">Dodaj mecz</button>
    </form>
    <h3>Lista meczów</h3>
    <table id="matchesTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Drużyna A</th>
          <th>Drużyna B</th>
          <th>Wynik</th>
          <th>Najlepsi Jaguar</th>
          <th>Oceny Jaguar</th>
          <th>Najlepsi przeciwnik</th>
          <th>Oceny przeciwnik</th>
          <th>Ocena meczu</th>
          <th>Akcje</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- POSTĘP -->
  <section id="progress" class="hidden">
    <h2>Postęp zawodników</h2>
    <label for="chartTeamSelect">Wybierz drużynę:</label>
    <select id="chartTeamSelect"></select>
    <div id="charts">
      <canvas id="trainingChart" width="450" height="250"></canvas>
      <canvas id="matchChart" width="450" height="250"></canvas>
    </div>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAWXiBO5-woCCEqCBc2rfOIo1RhUUtevzU",
    authDomain: "jaguar-analityka.firebaseapp.com",
    databaseURL: "https://jaguar-analityka-default-rtdb.firebaseio.com",
    projectId: "jaguar-analityka",
    storageBucket: "jaguar-analityka.appspot.com",
    messagingSenderId: "797947184851",
    appId: "1:797947184851:web:0cc25ca0dd8b178f418c26",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ELEMENTY DOM
  const loginSection = document.getElementById('loginSection');
  const loginForm = document.getElementById('loginForm');
  const authMessage = document.getElementById('authMessage');

  const mainNav = document.getElementById('mainNav');
  const navButtons = mainNav.querySelectorAll('button[data-tab]');
  const logoutBtn = document.getElementById('logoutBtn');

  const sections = {
    teams: document.getElementById('teams'),
    matches: document.getElementById('matches'),
    progress: document.getElementById('progress'),
  };

  // DRUŻYNY I ZAWODNICY
  const teamForm = document.getElementById('teamForm');
  const teamsList = document.getElementById('teamsList');
  const teamDetails = document.getElementById('teamDetails');
  const teamNameDisplay = document.getElementById('teamNameDisplay');
  const playerForm = document.getElementById('playerForm');
  const playersList = document.getElementById('playersList');
  const playerDetails = document.getElementById('playerDetails');
  const playerDetailName = document.getElementById('playerDetailName');
  const trainingScoreForm = document.getElementById('trainingScoreForm');
  const trainingScoreInput = document.getElementById('trainingScoreInput');
  const matchScoreForm = document.getElementById('matchScoreForm');
  const matchScoreInputPlayer = document.getElementById('matchScoreInputPlayer');
  const closePlayerDetailsBtn = document.getElementById('closePlayerDetailsBtn');

  // MECZE
  const matchForm = document.getElementById('matchForm');
  const teamASelect = document.getElementById('teamASelect');
  const teamBName = document.getElementById('teamBName');
  const matchesTableBody = document.querySelector('#matchesTable tbody');
  const jaguarBestPlayersDiv = document.getElementById('jaguarBestPlayers');
  const jaguarPlayersRatingsDiv = document.getElementById('jaguarPlayersRatings');
  const opponentPlayersRatingsDiv = document.getElementById('opponentPlayersRatings');

  // WYKRESY
  const chartTeamSelect = document.getElementById('chartTeamSelect');
  const trainingChartCanvas = document.getElementById('trainingChart');
  const matchChartCanvas = document.getElementById('matchChart');

  // STANY
  let currentUser = null;
  let currentTeamId = null;
  let currentPlayerId = null;
  let teamsData = {};
  let playersData = {};
  let matchesData = {};
  let trainingChart = null;
  let matchChart = null;

  // LOGOWANIE
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    authMessage.textContent = '';
    const email = loginForm.email.value.trim();
    const password = loginForm.password.value;
    auth.signInWithEmailAndPassword(email, password)
      .then(cred => { currentUser = cred.user; loginSection.classList.add('hidden'); mainNav.classList.remove('hidden'); sections.teams.classList.remove('hidden'); loadTeams(); })
      .catch(err => authMessage.textContent = 'Błąd logowania: ' + err.message);
  });

  logoutBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
      currentUser = null;
      loginSection.classList.remove('hidden');
      mainNav.classList.add('hidden');
      Object.values(sections).forEach(s => s.classList.add('hidden'));
      resetUI();
    });
  });

  auth.onAuthStateChanged(user => {
    if (user) { currentUser = user; loginSection.classList.add('hidden'); mainNav.classList.remove('hidden'); sections.teams.classList.remove('hidden'); loadTeams(); }
    else { currentUser = null; loginSection.classList.remove('hidden'); mainNav.classList.add('hidden'); Object.values(sections).forEach(s => s.classList.add('hidden')); resetUI(); }
  });

  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      navButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      Object.values(sections).forEach(s => s.classList.add('hidden'));
      sections[btn.dataset.tab].classList.remove('hidden');
      if (btn.dataset.tab === 'teams') loadTeams();
      if (btn.dataset.tab === 'matches') { loadTeamsForMatches(); loadMatches(); }
      if (btn.dataset.tab === 'progress') loadTeamsForChart();
    });
  });

  // DODAJ DRUŻYNĘ
  teamForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = teamForm.teamName.value.trim();
    if (!name) return alert('Podaj nazwę drużyny');
    db.ref('teams').push({ name })
      .then(() => { teamForm.teamName.value = ''; loadTeams(); })
      .catch(err => alert('Błąd dodawania drużyny: ' + err.message));
  });

  function editTeam(teamId, oldName) {
    const newName = prompt("Podaj nową nazwę drużyny:", oldName);
    if (newName && newName.trim()) {
      db.ref(`teams/${teamId}`).update({ name: newName.trim() })
        .then(() => loadTeams())
        .catch(err => alert('Błąd edycji drużyny: ' + err.message));
    }
  }

  // WCZYTAJ DRUŻYNY
  function loadTeams() {
    db.ref('teams').once('value')
      .then(snapshot => {
        teamsData = snapshot.val() || {};
        teamsList.innerHTML = '';
        teamASelect.innerHTML = '';
        chartTeamSelect.innerHTML = '';
        for (const id in teamsData) {
          const li = document.createElement('li');
          const name = teamsData[id].name;
          li.innerHTML = `
            <span>${name}</span>
            <button onclick="editTeam('${id}', '${name.replace(/'/g,"\\'")}')">Edytuj</button>
          `;
          li.style.cursor = 'pointer';
          li.addEventListener('click', () => selectTeam(id));
          teamsList.appendChild(li);

          const optionA = document.createElement('option');
          optionA.value = id;
          optionA.textContent = name;
          teamASelect.appendChild(optionA);

          const optionChart = document.createElement('option');
          optionChart.value = id;
          optionChart.textContent = name;
          chartTeamSelect.appendChild(optionChart);
        }
        teamDetails.classList.add('hidden');
        currentTeamId = null;
        currentPlayerId = null;
        playersList.innerHTML = '';
        playerDetails.classList.add('hidden');
        updateJaguarBestPlayers();
      })
      .catch(err => alert('Błąd wczytywania drużyn: ' + err.message));
  }

  function selectTeam(teamId) {
    currentTeamId = teamId;
    teamNameDisplay.textContent = teamsData[teamId].name;
    teamDetails.classList.remove('hidden');
    loadPlayers(teamId);
    playerDetails.classList.add('hidden');
  }

  playerForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentTeamId) return alert('Wybierz drużynę');
    const playerName = playerForm.playerNameInput.value.trim();
    if (!playerName) return alert('Podaj imię i nazwisko zawodnika');
    db.ref(`players/${currentTeamId}`).push({
      name: playerName,
      trainingScores: {},
      matchScores: {}
    })
      .then(() => {
        playerForm.playerNameInput.value = '';
        loadPlayers(currentTeamId);
      })
      .catch(err => alert('Błąd dodawania zawodnika: ' + err.message));
  });

  function editPlayer(playerId, oldName) {
    if (!currentTeamId) return;
    const newName = prompt("Podaj nowe imię i nazwisko zawodnika:", oldName);
    if (newName && newName.trim()) {
      db.ref(`players/${currentTeamId}/${playerId}`).update({ name: newName.trim() })
        .then(() => loadPlayers(currentTeamId))
        .catch(err => alert('Błąd edycji zawodnika: ' + err.message));
    }
  }

  function loadPlayers(teamId) {
    db.ref(`players/${teamId}`).once('value')
      .then(snapshot => {
        playersData = snapshot.val() || {};
        playersList.innerHTML = '';
        playerDetails.classList.add('hidden');
        currentPlayerId = null;
        for (const id in playersData) {
          const name = playersData[id].name;
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${name}</span>
            <button onclick="editPlayer('${id}', '${name.replace(/'/g,"\\'")}')">Edytuj</button>
          `;
          li.addEventListener('click', () => showPlayerDetails(id));
          playersList.appendChild(li);
        }
      })
      .catch(err => alert('Błąd wczytywania zawodników: ' + err.message));
  }

  function showPlayerDetails(playerId) {
    if (!currentTeamId) return;
    currentPlayerId = playerId;
    const player = playersData[playerId];
    if (!player) return;
    playerDetailName.textContent = player.name;
    playerDetails.classList.remove('hidden');
  }

  trainingScoreForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentTeamId || !currentPlayerId) return alert('Wybierz zawodnika');
    const score = parseFloat(trainingScoreInput.value);
    if (isNaN(score) || score < 0 || score > 10) return alert('Podaj ocenę od 0 do 10');
    const newScoreKey = db.ref().push().key;
    db.ref(`players/${currentTeamId}/${currentPlayerId}/trainingScores/${newScoreKey}`).set(score)
      .then(() => {
        trainingScoreInput.value = '';
        loadPlayers(currentTeamId);
        showPlayerDetails(currentPlayerId);
      })
      .catch(err => alert('Błąd dodawania oceny treningu: ' + err.message));
  });

  matchScoreForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentTeamId || !currentPlayerId) return alert('Wybierz zawodnika');
    const score = parseFloat(matchScoreInputPlayer.value);
    if (isNaN(score) || score < 0 || score > 10) return alert('Podaj ocenę od 0 do 10');
    const newScoreKey = db.ref().push().key;
    db.ref(`players/${currentTeamId}/${currentPlayerId}/matchScores/${newScoreKey}`).set(score)
      .then(() => {
        matchScoreInputPlayer.value = '';
        loadPlayers(currentTeamId);
        showPlayerDetails(currentPlayerId);
      })
      .catch(err => alert('Błąd dodawania oceny meczu: ' + err.message));
  });

  closePlayerDetailsBtn.addEventListener('click', () => {
    playerDetails.classList.add('hidden');
    currentPlayerId = null;
  });

  // MECZE - nowe funkcje
  function loadTeamsForMatches() {
    db.ref('teams').once('value')
      .then(snapshot => {
        teamsData = snapshot.val() || {};
        teamASelect.innerHTML = '';
        for (const id in teamsData) {
          const name = teamsData[id].name;
          const optionA = document.createElement('option');
          optionA.value = id; optionA.textContent = name;
          teamASelect.appendChild(optionA);
        }
        updateJaguarBestPlayers();
      })
      .catch(err => alert('Błąd wczytywania drużyn: ' + err.message));
  }

  // 3 najlepszych z Jaguara (dynamika)
  function updateJaguarBestPlayers() {
    const teamId = teamASelect.value;
    jaguarBestPlayersDiv.innerHTML = '';
    jaguarPlayersRatingsDiv.innerHTML = '';
    if (!teamId) return;
    db.ref(`players/${teamId}`).once('value').then(snapshot => {
      const players = snapshot.val() || {};
      for (let i = 1; i <= 3; i++) {
        const select = document.createElement('select');
        select.name = `jaguarBestPlayer${i}`;
        select.required = true;
        select.innerHTML = '<option value="">- wybierz zawodnika -</option>';
        for (const pid in players) {
          const option = document.createElement('option');
          option.value = pid;
          option.textContent = players[pid].name;
          select.appendChild(option);
        }
        select.dataset.idx = i;
        jaguarBestPlayersDiv.appendChild(select);
      }
    });
  }
  teamASelect.addEventListener('change', updateJaguarBestPlayers);

  // Pola na oceny dla wybranych zawodników Jaguara
  jaguarBestPlayersDiv.addEventListener('change', function() {
    jaguarPlayersRatingsDiv.innerHTML = '';
    Array.from(jaguarBestPlayersDiv.querySelectorAll('select')).forEach((select, i) => {
      if (select.value) {
        const label = document.createElement('label');
        label.textContent = `Ocena zawodnika (${select.options[select.selectedIndex].text}, opcjonalnie):`;
        const input = document.createElement('input');
        input.type = 'number';
        input.name = `jaguarBestPlayerRating${i+1}`;
        input.min = 0;
        input.max = 10;
        input.step = 0.1;
        jaguarPlayersRatingsDiv.appendChild(label);
        jaguarPlayersRatingsDiv.appendChild(input);
      }
    });
  });

  // Pola na oceny dla zawodników drużyny przeciwnej (po wpisaniu nazwisk)
  document.querySelectorAll('input[name^="opponentBestPlayer"]').forEach((input, i) => {
    input.addEventListener('input', function() {
      opponentPlayersRatingsDiv.innerHTML = '';
      document.querySelectorAll('input[name^="opponentBestPlayer"]').forEach((inp, idx) => {
        if (inp.value) {
          const label = document.createElement('label');
          label.textContent = `Ocena zawodnika przeciwnika (${inp.value}, opcjonalnie):`;
          const ratingInput = document.createElement('input');
          ratingInput.type = 'number';
          ratingInput.name = `opponentBestPlayerRating${idx+1}`;
          ratingInput.min = 0;
          ratingInput.max = 10;
          ratingInput.step = 0.1;
          opponentPlayersRatingsDiv.appendChild(label);
          opponentPlayersRatingsDiv.appendChild(ratingInput);
        }
      });
    });
  });

  // DODAJ MECZ
  matchForm.addEventListener('submit', e => {
    e.preventDefault();
    const date = matchForm.matchDate.value;
    const teamA = matchForm.teamASelect.value;
    const teamB = matchForm.teamBName.value.trim();
    const score = matchForm.matchScore.value.trim();

    // Najlepsi z Jaguara
    const jaguarPlayersSelects = jaguarBestPlayersDiv.querySelectorAll('select');
    const jaguarBestPlayers = Array.from(jaguarPlayersSelects).map(sel => sel.value);

    // Najlepsi z drużyny przeciwnej
    const opponentBestPlayers = [
      matchForm.opponentBestPlayer1.value.trim(),
      matchForm.opponentBestPlayer2.value.trim(),
      matchForm.opponentBestPlayer3.value.trim()
    ];

    // Ocena meczu
    const matchRating = matchForm.matchRating.value ? parseFloat(matchForm.matchRating.value) : null;

    // Oceny zawodników Jaguara (opcjonalnie)
    const jaguarPlayersRatings = [];
    jaguarPlayersSelects.forEach((sel, i) => {
      const rating = matchForm[`jaguarBestPlayerRating${i+1}`]?.value;
      jaguarPlayersRatings.push(rating ? parseFloat(rating) : null);
    });

    // Oceny zawodników przeciwnika (opcjonalnie)
    const opponentPlayersRatings = [];
    for (let i = 1; i <= 3; i++) {
      const rating = matchForm[`opponentBestPlayerRating${i}`]?.value;
      opponentPlayersRatings.push(rating ? parseFloat(rating) : null);
    }

    if (!date || !teamA || !teamB || !score || jaguarBestPlayers.some(v=>!v) || opponentBestPlayers.some(v=>!v)) {
      alert('Uzupełnij wszystkie wymagane pola!');
      return;
    }

    db.ref('matches').push({
      date,
      teamA,
      teamBName: teamB,
      score,
      jaguarBestPlayers,
      opponentBestPlayers,
      matchRating,
      jaguarPlayersRatings,
      opponentPlayersRatings
    }).then(() => {
      matchForm.reset();
      loadMatches();
      updateJaguarBestPlayers();
      opponentPlayersRatingsDiv.innerHTML = '';
    })
    .catch(err => alert('Błąd dodawania meczu: ' + err.message));
  });

  // WCZYTAJ MECZE
  function loadMatches() {
    db.ref('matches').once('value')
      .then(snapshot => {
        matchesTableBody.innerHTML = '';
        const matches = snapshot.val() || {};
        for (const matchId in matches) {
          const match = matches[matchId];
          const tr = document.createElement('tr');
          // Ustal nazwiska zawodników Jaguara
          let jaguarNames = [];
          let jaguarRatings = [];
          if (match.jaguarBestPlayers && Array.isArray(match.jaguarBestPlayers)) {
            jaguarNames = match.jaguarBestPlayers.map(pid => {
              if (teamsData[match.teamA] && playersData[pid]) {
                return playersData[pid].name;
              }
              return pid;
            });
            jaguarRatings = (match.jaguarPlayersRatings || []).map(r => r !== null && r !== undefined && r!=='' ? r : '-');
          }
          // Ustal zawodników przeciwnika i oceny
          let opponentNames = (match.opponentBestPlayers || []).map(n => n || '-');
          let opponentRatings = (match.opponentPlayersRatings || []).map(r => r !== null && r !== undefined && r!=='' ? r : '-');

          tr.innerHTML = `
            <td>${match.date}</td>
            <td>${teamsData[match.teamA]?.name || ''}</td>
            <td>${match.teamBName || ''}</td>
            <td>${match.score}</td>
            <td>${jaguarNames.join('<br>')}</td>
            <td>${jaguarRatings.join('<br>')}</td>
            <td>${opponentNames.join('<br>')}</td>
            <td>${opponentRatings.join('<br>')}</td>
            <td>${match.matchRating !== undefined && match.matchRating !== null ? match.matchRating : '-'}</td>
          `;
          const tdAct = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Usuń';
          delBtn.style.backgroundColor = '#cc3333';
          delBtn.addEventListener('click', () => {
            if (confirm('Na pewno usunąć ten mecz?')) {
              db.ref(`matches/${matchId}`).remove().then(loadMatches).catch(err => alert('Błąd usuwania meczu: ' + err.message));
            }
          });
          tdAct.appendChild(delBtn);
          tr.appendChild(tdAct);
          matchesTableBody.appendChild(tr);
        }
      })
      .catch(err => alert('Błąd wczytywania meczów: ' + err.message));
  }

  // WYKRESY
  function loadTeamsForChart() {
    db.ref('teams').once('value')
      .then(snapshot => {
        teamsData = snapshot.val() || {};
        chartTeamSelect.innerHTML = '';
        for (const id in teamsData) {
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = teamsData[id].name;
          chartTeamSelect.appendChild(opt);
        }
        if (chartTeamSelect.options.length > 0) loadCharts(chartTeamSelect.value);
      })
      .catch(err => alert('Błąd wczytywania drużyn: ' + err.message));
  }

  chartTeamSelect.addEventListener('change', () => {
    if (chartTeamSelect.value) loadCharts(chartTeamSelect.value);
  });

  function loadCharts(teamId) {
    db.ref(`players/${teamId}`).once('value')
      .then(snapshot => {
        const players = snapshot.val() || {};
        const labels = [], avgTraining = [], avgMatch = [];
        for (const pid in players) {
          const p = players[pid];
          labels.push(p.name);
          const tArr = Object.values(p.trainingScores || {});
          const mArr = Object.values(p.matchScores || {});
          avgTraining.push(tArr.length ? (tArr.reduce((a,b) => a + b)/tArr.length).toFixed(2) : 0);
          avgMatch.push(mArr.length ? (mArr.reduce((a,b) => a + b)/mArr.length).toFixed(2) : 0);
        }

        if (trainingChart) trainingChart.destroy();
        if (matchChart) matchChart.destroy();

        trainingChart = new Chart(trainingChartCanvas.getContext('2d'), {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Średnia ocena treningu', data: avgTraining, backgroundColor: '#003366' }] },
          options: { scales: { y: { beginAtZero: true, max: 10 } }}
        });

        matchChart = new Chart(matchChartCanvas.getContext('2d'), {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Średnia ocena meczu', data: avgMatch, backgroundColor: '#0055aa' }] },
          options: { scales: { y: { beginAtZero: true, max: 10 } }}
        });
      })
      .catch(err => alert('Błąd rysowania wykresów: ' + err.message));
  }

  function resetUI() {
    teamsList.innerHTML = '';
    teamDetails.classList.add('hidden');
    playerDetails.classList.add('hidden');
    matchesTableBody.innerHTML = '';
    teamASelect.innerHTML = '';
    chartTeamSelect.innerHTML = '';
    jaguarBestPlayersDiv.innerHTML = '';
    jaguarPlayersRatingsDiv.innerHTML = '';
    opponentPlayersRatingsDiv.innerHTML = '';
    currentTeamId = null;
    currentPlayerId = null;
    teamsData = {};
    playersData = {};
    matchesData = {};
    if (trainingChart) trainingChart.destroy();
    if (matchChart) matchChart.destroy();
  }
</script>

</body>
</html>
</body>
</html>
