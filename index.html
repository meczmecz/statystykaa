<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jaguar Panel Trenerski</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 0; }
  header { background: #003366; color: white; padding: 1rem; text-align: center; }
  nav { display: flex; gap: 1rem; padding: 0.5rem; background: #0055aa; justify-content: center; }
  nav button { padding: 0.5rem 1rem; border: none; border-radius: 5px; background: white; color: #0055aa; cursor: pointer; font-weight: bold; }
  nav button:hover { background: #ddd; }
  section { max-width: 900px; margin: 1rem auto; background: white; padding: 1rem; border-radius: 8px; display: none; }
  section.active { display: block; }
  input, select, textarea, button { width: 100%; margin: 0.5rem 0; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
  button { background: #0055aa; color: white; font-weight: bold; cursor: pointer; }
  #logoutBtn { background: #cc3300; margin-top: 1rem; }
  .error { color: red; }
</style>
</head>
<body>

<header><h1>Jaguar Panel Trenerski</h1></header>

<div id="authSection">
  <h2>Zaloguj się</h2>
  <input type="email" id="email" placeholder="Email" required />
  <input type="password" id="password" placeholder="Hasło" required />
  <button id="loginBtn">Zaloguj</button>
  <p>Nie masz konta? <button id="registerBtn" style="background:#28a745;">Zarejestruj się</button></p>
  <p class="error" id="authError"></p>
</div>

<nav id="mainNav" style="display:none;">
  <button onclick="showTab('analiza')">Analiza</button>
  <button onclick="showTab('druzyny')">Drużyny</button>
  <button onclick="showTab('zawodnicy')">Zawodnicy</button>
  <button id="logoutBtn">Wyloguj</button>
</nav>

<!-- ANALIZA -->
<section id="analiza" class="active">
  <h2>Analiza meczu</h2>
  <form id="matchForm">
    <input type="date" id="matchDate" required />
    <input type="text" id="matchOpponent" placeholder="Przeciwnik (np. FC Rywale)" required />
    <input type="text" id="matchResult" placeholder="Wynik meczu (np. 3-1)" required />
    <input type="text" id="scorers" placeholder="Strzelcy (oddziel przecinkami)" />
    <input type="text" id="bestPlayer" placeholder="Najlepszy zawodnik" />
    <textarea id="matchDescription" placeholder="Opis meczu"></textarea>

    <label>3 najlepszych zawodników Jag:</label>
    <input type="text" id="topJag1" placeholder="1. zawodnik" required />
    <input type="text" id="topJag2" placeholder="2. zawodnik" required />
    <input type="text" id="topJag3" placeholder="3. zawodnik" required />

    <label>3 najlepszych zawodników drużyny przeciwnika:</label>
    <input type="text" id="topOpp1" placeholder="1. zawodnik" required />
    <input type="text" id="topOpp2" placeholder="2. zawodnik" required />
    <input type="text" id="topOpp3" placeholder="3. zawodnik" required />

    <button type="submit">Zapisz mecz</button>
  </form>
  <div id="matchesList"></div>
</section>

<!-- DRUZYNY -->
<section id="druzyny">
  <h2>Drużyny</h2>
  <form id="teamForm">
    <input type="text" id="teamName" placeholder="Nazwa drużyny" required />
    <input type="text" id="teamPlayers" placeholder="Zawodnicy (oddzieleni przecinkami)" />
    <button type="submit">Dodaj drużynę</button>
  </form>
  <div id="teamsList"></div>
</section>

<!-- ZAWODNICY -->
<section id="zawodnicy">
  <h2>Zawodnicy i oceny</h2>
  <form id="playerRatingForm">
    <select id="selectTeam" required>
      <option value="">Wybierz drużynę</option>
    </select>
    <select id="selectPlayer" required>
      <option value="">Wybierz zawodnika</option>
    </select>
    <input type="date" id="ratingDate" required />
    <input type="number" id="trainingRating" min="1" max="5" placeholder="Ocena z treningu (1-5)" required />
    <input type="number" id="matchRating" min="1" max="5" placeholder="Ocena z meczu (1-5)" required />
    <input type="number" id="playTime" min="0" placeholder="Czas gry (minuty)" />
    <button type="submit">Zapisz ocenę</button>
  </form>
  <canvas id="chartTraining" width="400" height="150"></canvas>
  <canvas id="chartMatch" width="400" height="150"></canvas>
</section>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAWXiBO5-woCCEqCBc2rfOIo1RhUUtevzU",
    authDomain: "jaguar-analityka.firebaseapp.com",
    databaseURL: "https://jaguar-analityka-default-rtdb.firebaseio.com",
    projectId: "jaguar-analityka",
    storageBucket: "jaguar-analityka.firebasestorage.app",
    messagingSenderId: "163915747034",
    appId: "1:163915747034:web:8c0311eaaa4ed792b25fe3",
    measurementId: "G-T3C1M10SM6"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // UI elements
  const authSection = document.getElementById('authSection');
  const mainNav = document.getElementById('mainNav');
  const logoutBtn = document.getElementById('logoutBtn');
  const authError = document.getElementById('authError');

  const matchForm = document.getElementById('matchForm');
  const matchesList = document.getElementById('matchesList');

  const teamForm = document.getElementById('teamForm');
  const teamsList = document.getElementById('teamsList');

  const playerRatingForm = document.getElementById('playerRatingForm');
  const selectTeam = document.getElementById('selectTeam');
  const selectPlayer = document.getElementById('selectPlayer');

  let currentUser = null;

  // Pokazuje sekcje (zakładki)
  function showTab(id) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // Logowanie i rejestracja
  document.getElementById('loginBtn').addEventListener('click', () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => authError.textContent = err.message);
  });
  document.getElementById('registerBtn').addEventListener('click', () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    auth.createUserWithEmailAndPassword(email, password)
      .catch(err => authError.textContent = err.message);
  });
  logoutBtn.addEventListener('click', () => auth.signOut());

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      authSection.style.display = 'none';
      mainNav.style.display = 'flex';
      showTab('analiza');
      loadTeams();
      loadMatches();
    } else {
      currentUser = null;
      authSection.style.display = 'block';
      mainNav.style.display = 'none';
      matchesList.innerHTML = '';
      teamsList.innerHTML = '';
      selectTeam.innerHTML = '<option value="">Wybierz drużynę</option>';
      selectPlayer.innerHTML = '<option value="">Wybierz zawodnika</option>';
    }
  });

  // ZAPIS MECZU
  matchForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentUser) return alert('Musisz być zalogowany!');

    const matchData = {
      date: document.getElementById('matchDate').value,
      opponent: document.getElementById('matchOpponent').value.trim(),
      result: document.getElementById('matchResult').value.trim(),
      scorers: document.getElementById('scorers').value.trim(),
      bestPlayer: document.getElementById('bestPlayer').value.trim(),
      description: document.getElementById('matchDescription').value.trim(),
      topJag: [
        document.getElementById('topJag1').value.trim(),
        document.getElementById('topJag2').value.trim(),
        document.getElementById('topJag3').value.trim()
      ],
      topOpp: [
        document.getElementById('topOpp1').value.trim(),
        document.getElementById('topOpp2').value.trim(),
        document.getElementById('topOpp3').value.trim()
      ],
      createdBy: currentUser.uid,
      timestamp: Date.now()
    };

    // Zapis do bazy
    db.ref('matches').push(matchData)
      .then(() => {
        alert('Mecz zapisany!');
        matchForm.reset();
        loadMatches();
      })
      .catch(err => alert('Błąd zapisu: ' + err.message));
  });

  // Wczytanie meczów i pokazanie w tabeli
  function loadMatches() {
    matchesList.innerHTML = '<h3>Lista meczów</h3>';
    const table = document.createElement('table');
    table.border = '1';
    table.style.width = '100%';
    const header = table.insertRow();
    ['Data', 'Przeciwnik', 'Wynik', 'Strzelcy', 'Najlepszy', 'Top 3 Jaguar', 'Top 3 Przeciwnik'].forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      header.appendChild(th);
    });

    db.ref('matches').orderByChild('timestamp').limitToLast(50).once('value', snapshot => {
      if (!snapshot.exists()) {
        matchesList.innerHTML += '<p>Brak zapisanych meczów.</p>';
        return;
      }
      snapshot.forEach(child => {
        const m = child.val();
        const row = table.insertRow();
        row.insertCell().textContent = m.date;
        row.insertCell().textContent = m.opponent;
        row.insertCell().textContent = m.result;
        row.insertCell().textContent = m.scorers;
        row.insertCell().textContent = m.bestPlayer;
        row.insertCell().textContent = m.topJag.join(', ');
        row.insertCell().textContent = m.topOpp.join(', ');
      });
      matchesList.appendChild(table);
    });
  }

  // ZARZĄDZANIE DRUŻYNAMI
  teamForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentUser) return alert('Musisz być zalogowany!');

    const name = document.getElementById('teamName').value.trim();
    const playersRaw = document.getElementById('teamPlayers').value.trim();
    const players = playersRaw ? playersRaw.split(',').map(p => p.trim()) : [];

    // dodaj do bazy drużynę z zawodnikami
    db.ref('teams').push({ name, players })
      .then(() => {
        alert('Drużyna dodana!');
        teamForm.reset();
        loadTeams();
      })
      .catch(err => alert('Błąd: ' + err.message));
  });

  // Wczytaj drużyny i uzupełnij selecty
  function loadTeams() {
    selectTeam.innerHTML = '<option value="">Wybierz drużynę</option>';
    teamsList.innerHTML = '<h3>Lista drużyn</h3>';
    db.ref('teams').once('value', snapshot => {
      if (!snapshot.exists()) {
        teamsList.innerHTML += '<p>Brak drużyn.</p>';
        return;
      }
      const table = document.createElement('table');
      table.border = '1';
      table.style.width = '100%';
      const header = table.insertRow();
      ['Nazwa drużyny', 'Zawodnicy'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        header.appendChild(th);
      });

      selectTeam.innerHTML = '<option value="">Wybierz drużynę</option>';

      snapshot.forEach(child => {
        const t = child.val();
        const id = child.key;
        // tabela
        const row = table.insertRow();
        row.insertCell().textContent = t.name;
        row.insertCell().textContent = t.players.join(', ');
        // select
        const option = document.createElement('option');
        option.value = id;
        option.textContent = t.name;
        selectTeam.appendChild(option);
      });
      teamsList.appendChild(table);
    });
  }

  // Po wyborze drużyny pokaż zawodników w selectPlayer
  selectTeam.addEventListener('change', () => {
    selectPlayer.innerHTML = '<option value="">Wybierz zawodnika</option>';
    const teamId = selectTeam.value;
    if (!teamId) return;
    db.ref('teams/' + teamId).once('value', snapshot => {
      if (!snapshot.exists()) return;
      const t = snapshot.val();
      t.players.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        selectPlayer.appendChild(opt);
      });
    });
  });

  // DODAWANIE OCEN
  playerRatingForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentUser) return alert('Musisz być zalogowany!');

    const teamId = selectTeam.value;
    const playerName = selectPlayer.value;
    const date = document.getElementById('ratingDate').value;
    const trainingRating = Number(document.getElementById('trainingRating').value);
    const matchRating = Number(document.getElementById('matchRating').value);
    const playTime = Number(document.getElementById('playTime').value);

    if (!teamId || !playerName || !date) return alert('Wypełnij wszystkie pola!');

    const ratingData = {
      teamId,
      playerName,
      date,
      trainingRating,
      matchRating,
      playTime,
      createdBy: currentUser.uid,
      timestamp: Date.now()
    };

    db.ref('ratings').push(ratingData)
      .then(() => {
        alert('Ocena zapisana!');
        playerRatingForm.reset();
        loadCharts(teamId, playerName);
      })
      .catch(err => alert('Błąd zapisu oceny: ' + err.message));
  });

  // Ładuj wykresy ocen zawodnika
  const ctxTraining = document.getElementById('chartTraining').getContext('2d');
  const ctxMatch = document.getElementById('chartMatch').getContext('2d');
  let chartTraining = null;
  let chartMatch = null;

  function loadCharts(teamId, playerName) {
    db.ref('ratings').orderByChild('timestamp').once('value', snapshot => {
      if (!snapshot.exists()) {
        clearCharts();
        return;
      }
      const dataTraining = [];
      const dataMatch = [];
      snapshot.forEach(child => {
        const r = child.val();
        if (r.teamId === teamId && r.playerName === playerName) {
          dataTraining.push({ x: r.date, y: r.trainingRating });
          dataMatch.push({ x: r.date, y: r.matchRating });
        }
      });

      dataTraining.sort((a,b) => new Date(a.x) - new Date(b.x));
      dataMatch.sort((a,b) => new Date(a.x) - new Date(b.x));

      // Zniszcz stare wykresy jeśli istnieją
      if (chartTraining) chartTraining.destroy();
      if (chartMatch) chartMatch.destroy();

      chartTraining = new Chart(ctxTraining, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Ocena trening',
            data: dataTraining,
            borderColor: 'blue',
            backgroundColor: 'rgba(0,0,255,0.1)',
            fill: true,
            tension: 0.3,
            parsing: {
              xAxisKey: 'x',
              yAxisKey: 'y'
            }
          }]
        },
        options: {
          scales: {
            x: { type: 'time', time: { unit: 'day' }, title: { display: true, text: 'Data' } },
            y: { min: 1, max: 5, title: { display: true, text: 'Ocena' } }
          }
        }
      });

      chartMatch = new Chart(ctxMatch, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Ocena mecz',
            data: dataMatch,
            borderColor: 'green',
            backgroundColor: 'rgba(0,255,0,0.1)',
            fill: true,
            tension: 0.3,
            parsing: {
              xAxisKey: 'x',
              yAxisKey: 'y'
            }
          }]
        },
        options: {
          scales: {
            x: { type: 'time', time: { unit: 'day' }, title: { display: true, text: 'Data' } },
            y: { min: 1, max: 5, title: { display: true, text: 'Ocena' } }
          }
        }
      });
    });
  }

  function clearCharts() {
    if (chartTraining) chartTraining.destroy();
    if (chartMatch) chartMatch.destroy();
  }

</script>

</body>
</html>
