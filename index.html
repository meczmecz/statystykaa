<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jaguar Analityka - zarządzanie drużynami i meczami</title>
<style>
  /* Twoje istniejące style + kilka nowych */
  body { font-family:Arial,sans-serif; margin:0; padding:0; background:#f4f7fa; }
  header { background:#003366; color:white; padding:15px; text-align:center; font-size:1.5em; font-weight:bold; }
  main { max-width:1000px; margin:20px auto; background:white; padding:20px; border-radius:8px; box-shadow:0 0 10px #aaa; }
  section { margin-bottom:30px; }
  h2 { border-bottom:2px solid #003366; padding-bottom:5px; margin-bottom:15px; color:#003366; }
  label { display:block; margin:8px 0 4px; }
  input, select, textarea { width:100%; padding:6px 8px; border:1px solid #bbb; border-radius:4px; font-size:1em; }
  button { background:#003366; color:white; border:none; padding:8px 16px; margin-top:12px; cursor:pointer; border-radius:4px; font-weight:bold; transition:background-color .3s; }
  button:hover { background:#0055aa; }
  nav { margin-bottom:20px; text-align:center; }
  nav button { margin:0 8px; padding:10px 20px; font-size:1em; border-radius:4px; border:2px solid #003366; background:white; color:#003366; cursor:pointer; font-weight:bold; }
  nav button.active, nav button:hover { background:#003366; color:white; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  table th, table td { border:1px solid #ddd; padding:8px; text-align:left; }
  table th { background:#003366; color:white; }
  .hidden { display:none; }
  #playersList li { cursor:pointer; padding:4px 8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
  #playersList li button { background:#cc3333; margin-left:8px; padding:2px 6px; font-size:.9em; }
  #teamsList li { cursor:pointer; padding:4px 8px; display:flex; justify-content:space-between; align-items:center; }
  #teamsList li button { background:#cc3333; margin-left:8px; padding:2px 6px; font-size:.9em; }
  #playerDetails { margin-top:15px; border-top:1px solid #ccc; padding-top:10px; }
  /* Nowe style dla formatek meczu */
  .player-stats { margin:8px 0; padding:8px; background:#eef; border-radius:4px; }
  .player-stats input { width: auto; display: inline-block; margin-right:8px; }
</style>
</head>
<body>

<header>Jaguar Analityka - Zarządzanie drużynami i meczami</header>
<main>

  <!-- LOGIN -->
  <section id="loginSection">
    <h2>Logowanie</h2>
    <form id="loginForm">
      <label>Email:</label><input type="email" id="email" required placeholder="Twój email" />
      <label>Hasło:</label><input type="password" id="password" required placeholder="Twoje hasło" />
      <button type="submit">Zaloguj się</button>
    </form>
    <div id="authMessage"></div>
  </section>

  <nav id="mainNav" class="hidden">
    <button data-tab="teams" class="active">Drużyny</button>
    <button data-tab="matches">Mecze</button>
    <button data-tab="progress">Postęp</button>
    <button id="logoutBtn">Wyloguj</button>
  </nav>

  <!-- DRUŻYNY -->
  <section id="teams" class="hidden active">
    <h2>Drużyny i zawodnicy</h2>
    <form id="teamForm">
      <label>Nazwa drużyny:</label><input type="text" id="teamName" required placeholder="Wpisz nazwę drużyny" />
      <button type="submit">Dodaj drużynę</button>
    </form>
    <ul id="teamsList"></ul>
    <div id="teamDetails" class="hidden">
      <h3>Drużyna: <span id="teamNameDisplay"></span></h3>
      <form id="playerForm">
        <label>Dodaj zawodnika:</label><input type="text" id="playerNameInput" required placeholder="Imię i nazwisko" />
        <button type="submit">Dodaj zawodnika</button>
      </form>
      <ul id="playersList"></ul>
      <div id="playerDetails" class="hidden">
        <h4>Szczegóły zawodnika: <span id="playerDetailName"></span></h4>
        <form id="trainingScoreForm">
          <label>Ocena treningu (0–10):</label><input type="number" id="trainingScoreInput" min="0" max="10" step="0.1" required />
          <button type="submit">Dodaj ocenę treningu</button>
        </form>
        <form id="matchScoreForm" style="margin-top:10px;">
          <label>Ocena meczu (0–10):</label><input type="number" id="matchScoreInputPlayer" min="0" max="10" step="0.1" required />
          <button type="submit">Dodaj ocenę meczu</button>
        </form>
        <button id="closePlayerDetailsBtn" style="margin-top:10px;">Zamknij szczegóły zawodnika</button>
      </div>
    </div>
  </section>

  <!-- MECZE -->
  <section id="matches" class="hidden">
    <h2>Dodaj nowy mecz</h2>
    <form id="matchForm">
      <label>Data meczu:</label><input type="date" id="matchDate" required />
      <label>Drużyna A:</label><select id="teamASelect" required></select>
      
      <label>Drużyna B (wybór):</label>
      <select id="teamBSelect"></select>
      <label>lub wpisz inną:</label>
      <input type="text" id="teamBInput" placeholder="Wpisz nazwę drużyny B" />

      <label>Wynik (np. 3:1):</label><input type="text" id="matchScore" placeholder="np. 3:1" required />
      <label>Ocena meczu (0-10):</label><input type="number" id="matchRating" min="0" max="10" step="0.1" required />

      <div id="playerStatsContainer"></div>

      <button type="submit">Dodaj mecz</button>
    </form>

    <h3>Lista meczów</h3>
    <table id="matchesTable">
      <thead><tr><th>Data</th><th>A</th><th>B</th><th>Wynik</th><th>Ocena meczu</th><th>Top 3</th><th>Akcje</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- POSTĘP -->
  <section id="progress" class="hidden">
    <h2>Postęp zawodników</h2>
    <label>Wybierz drużynę:</label><select id="chartTeamSelect"></select>
    <div id="charts">
      <canvas id="trainingChart" width="450" height="250"></canvas>
      <canvas id="matchChart" width="450" height="250"></canvas>
    </div>
  </section>

</main>

<!-- Skrypty -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Inicjalizacja Firebase i referencje
  const firebaseConfig = { /* ... Twoje dane ... */ };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth(), db = firebase.database();

  // DOM references...
  const loginSection = document.getElementById('loginSection');
  const loginForm = document.getElementById('loginForm');
  const authMessage = document.getElementById('authMessage');
  const mainNav = document.getElementById('mainNav');
  const navButtons = mainNav.querySelectorAll('button[data-tab]');
  const logoutBtn = document.getElementById('logoutBtn');
  const sections = {
    teams: document.getElementById('teams'),
    matches: document.getElementById('matches'),
    progress: document.getElementById('progress')
  };

  const teamForm = document.getElementById('teamForm');
  const teamsList = document.getElementById('teamsList');
  const teamDetails = document.getElementById('teamDetails');
  const teamNameDisplay = document.getElementById('teamNameDisplay');

  const playerForm = document.getElementById('playerForm');
  const playersList = document.getElementById('playersList');

  const playerDetails = document.getElementById('playerDetails');
  const playerDetailName = document.getElementById('playerDetailName');
  const trainingScoreForm = document.getElementById('trainingScoreForm');
  const trainingScoreInput = document.getElementById('trainingScoreInput');
  const matchScoreForm = document.getElementById('matchScoreForm');
  const matchScoreInputPlayer = document.getElementById('matchScoreInputPlayer');
  const closePlayerDetailsBtn = document.getElementById('closePlayerDetailsBtn');

  const matchForm = document.getElementById('matchForm');
  const teamASelect = document.getElementById('teamASelect');
  const teamBSelect = document.getElementById('teamBSelect');
  const teamBInput = document.getElementById('teamBInput');
  const matchDate = document.getElementById('matchDate');
  const matchScore = document.getElementById('matchScore');
  const matchRatingInput = document.getElementById('matchRating');
  const playerStatsContainer = document.getElementById('playerStatsContainer');
  const matchesTableBody = document.querySelector('#matchesTable tbody');

  const chartTeamSelect = document.getElementById('chartTeamSelect');
  const trainingChartCanvas = document.getElementById('trainingChart');
  const matchChartCanvas = document.getElementById('matchChart');
  let trainingChart, matchChart;

  let currentUser=null, currentTeamId=null, currentPlayerId=null;
  let teamsData={}, playersData={}, matchesData={};

  // AUTORYZACJA
  auth.onAuthStateChanged(user => {
    if (user) { currentUser=user; loginSection.classList.add('hidden'); mainNav.classList.remove('hidden'); sections.teams.classList.remove('hidden'); loadTeams(); }
    else { currentUser=null; loginSection.classList.remove('hidden'); mainNav.classList.add('hidden'); Object.values(sections).forEach(s=>s.classList.add('hidden')); resetUI(); }
  });

  loginForm.addEventListener('submit', e=>{ e.preventDefault(); authMessage.textContent=''; auth.signInWithEmailAndPassword(loginForm.email.value.trim(), loginForm.password.value).catch(err=>authMessage.textContent='Błąd logowania: '+err.message); });

  logoutBtn.addEventListener('click', ()=> auth.signOut());

  navButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      navButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      Object.values(sections).forEach(s=>s.classList.add('hidden'));
      sections[btn.dataset.tab].classList.remove('hidden');
      if (btn.dataset.tab==='teams') loadTeams();
      if (btn.dataset.tab==='matches') loadTeamsForMatches(), loadMatches();
      if (btn.dataset.tab==='progress') loadTeamsForChart();
    });
  });

  // DRUŻYNY
  teamForm.addEventListener('submit', e=>{
    e.preventDefault();
    const name=teamName.value.trim(); if (!name) return alert('Podaj nazwę drużyny');
    db.ref('teams').push({ name }).then(()=>teamForm.reset());
  });

  function loadTeams(){
    db.ref('teams').once('value').then(snap=>{
      teamsData=snap.val()||{};
      teamsList.innerHTML=''; teamASelect.innerHTML=''; teamBSelect.innerHTML=''; chartTeamSelect.innerHTML='';
      for (const id in teamsData){
        const name=teamsData[id].name;
        const li=document.createElement('li');
        li.textContent=name;
        li.onclick=()=>selectTeam(id);
        // Edytuj drużynę
        const edit=document.createElement('button');
        edit.textContent='✏️';
        edit.onclick=()=>{
          const nn=prompt('Nowa nazwa drużyny',name);
          if(nn) db.ref(`teams/${id}`).update({ name: nn });
        };
        const del=document.createElement('button');
        del.textContent='🗑️';
        del.onclick=()=>{
          if(confirm('Usunąć drużynę i wszystkich zawodników?')) db.ref(`teams/${id}`).remove().then(loadTeams);
        };
        li.append(edit,del);
        teamsList.appendChild(li);

        [teamASelect, teamBSelect, chartTeamSelect].forEach(sel=>{
          const opt=document.createElement('option');
          opt.value=id; opt.textContent=name;
          sel.appendChild(opt);
        });
      }
      teamDetails.classList.add('hidden');
      playersList.innerHTML='';
      playerDetails.classList.add('hidden');
    });
  }

  function selectTeam(id){
    currentTeamId=id;
    teamNameDisplay.textContent=teamsData[id].name;
    teamDetails.classList.remove('hidden');
    loadPlayers(id);
    playerDetails.classList.add('hidden');
  }

  // ZAWODNICY
  playerForm.addEventListener('submit', e=>{
    e.preventDefault();
    if (!currentTeamId) return alert('Wybierz drużynę');
    const name=playerNameInput.value.trim();
    if (!name) return alert('Podaj imię i nazwisko');
    db.ref(`players/${currentTeamId}`).push({ name, trainingScores:{}, matchScores:{} }).then(()=>playerForm.reset());
  });

  function loadPlayers(teamId){
    db.ref(`players/${teamId}`).once('value').then(snap=>{
      playersData=snap.val()||{};
      playersList.innerHTML='';
      for(const id in playersData){
        const name=playersData[id].name;
        const li=document.createElement('li');
        const span=document.createElement('span'); span.textContent=name;
        span.onclick=()=>showPlayerDetails(id);
        const edit=document.createElement('button');
        edit.textContent='✏️';
        edit.onclick=()=>{
          const nn=prompt('Nowe imię i nazwisko',name);
          if(nn) db.ref(`players/${currentTeamId}/${id}`).update({ name: nn }).then(()=>loadPlayers(currentTeamId));
        };
        const del=document.createElement('button');
        del.textContent='🗑️';
        del.onclick=()=>{
          if(confirm('Usunąć zawodnika?')) db.ref(`players/${currentTeamId}/${id}`).remove().then(()=>loadPlayers(currentTeamId));
        };
        li.append(span, edit, del);
        playersList.appendChild(li);
      }
    });
  }

  function showPlayerDetails(pid){
    currentPlayerId=pid;
    playerDetailName.textContent=playersData[pid].name;
    playerDetails.classList.remove('hidden');
  }

  trainingScoreForm.addEventListener('submit', e=>{
    e.preventDefault();
    const score=parseFloat(trainingScoreInput.value);
    if(isNaN(score)||score<0||score>10) return alert('Nieprawidłowa ocena');
    const k=db.ref().push().key;
    db.ref(`players/${currentTeamId}/${currentPlayerId}/trainingScores/${k}`).set(score).then(()=>{
      trainingScoreInput.value=''; loadPlayers(currentTeamId);
    });
  });

  matchScoreForm.addEventListener('submit', e=>{
    e.preventDefault();
    const score=parseFloat(matchScoreInputPlayer.value);
    if(isNaN(score)||score<0||score>10) return alert('Nieprawidłowa ocena');
    const k=db.ref().push().key;
    db.ref(`players/${currentTeamId}/${currentPlayerId}/matchScores/${k}`).set(score).then(()=>{
      matchScoreInputPlayer.value=''; loadPlayers(currentTeamId);
    });
  });

  closePlayerDetailsBtn.addEventListener('click',()=>playerDetails.classList.add('hidden'));

  // MECZE
  function loadTeamsForMatches(){
    db.ref('teams').once('value').then(snap=>{
      teamsData=snap.val()||{};
      teamASelect.innerHTML='';
      teamBSelect.innerHTML='';
      for(const id in teamsData){
        [teamASelect, teamBSelect].forEach(sel=>{
          const opt=document.createElement('option');
          opt.value=id; opt.textContent=teamsData[id].name;
          sel.appendChild(opt);
        });
      }
      updatePlayerStatsInputs();
    });
  }

  teamASelect.addEventListener('change', updatePlayerStatsInputs);
  teamBSelect.addEventListener('change', updatePlayerStatsInputs);
  teamBInput.addEventListener('input', ()=> {}); // placeholder

  function updatePlayerStatsInputs(){
    playerStatsContainer.innerHTML='';
    const tA=teamASelect.value, tB=teamBSelect.value;
    [ {tid:tA, label:'A'}, {tid:tB, label:'B'} ].forEach(gr=>{
      if(!gr.tid) return;
      db.ref(`players/${gr.tid}`).once('value').then(snap=>{
        const pd=snap.val()||{};
        const div=document.createElement('div');
        div.innerHTML=`<h4>Drużyna ${gr.label}</h4>`;
        for(const pid in pd){
          const name=pd[pid].name;
          const statDiv=document.createElement('div');
          statDiv.classList.add('player-stats');
          statDiv.innerHTML=`
            <strong>${name}</strong> 
            Czas: <input type="number" min="0" name="time|${pid}"> 
            Bramki: <input type="number" min="0" name="goals|${pid}"> 
            Ocena: <input type="number" min="0" max="10" step="0.1" name="score|${pid}">
          `;
          div.appendChild(statDiv);
        }
        playerStatsContainer.appendChild(div);
      });
    });
  }

  matchForm.addEventListener('submit', e=>{
    e.preventDefault();
    const date=matchDate.value, teamA=teamASelect.value;
    let teamB = teamBSelect.value;
    const customB = teamBInput.value.trim();
    if(customB){
      teamBInput.value='';
      const newBkey=db.ref('teams').push({ name: customB }).key;
      db.ref(`teams/${newBkey}/name`).set(customB);
      teamB=newBkey;
    }
    const score=matchScore.value.trim();
    const matchRating=parseFloat(matchRatingInput.value);
    if(!date||!teamA||!teamB||!score||isNaN(matchRating)) return alert('Uzupełnij wszystkie pola');
    if(teamA===teamB) return alert('Drużyny muszą być różne');

    const fm=new FormData(matchForm);
    const playersStats = {};
    for(const [k,v] of fm.entries()){
      const [fld,pid]=k.split('|');
      if(!playersStats[pid]) playersStats[pid]={time:0,goals:0,score:0};
      playersStats[pid][fld]= (fld==='time'||fld==='goals') ? parseInt(v)||0 : parseFloat(v)||0;
    }

    const mref=db.ref('matches').push();
    mref.set({ date, teamA, teamB, score, matchRating, playersStats })
      .then(()=>{
        matchForm.reset();
        loadTeams();
        loadTeamsForMatches();
        loadMatches();
      });
  });

  function loadMatches(){
    db.ref('matches').once('value').then(snap=>{
      matchesData=snap.val()||{};
      matchesTableBody.innerHTML='';
      for(const mid in matchesData){
        const m=matchesData[mid];
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${m.date}</td><td>${teamsData[m.teamA]?.name||'?'}</td><td>${teamsData[m.teamB]?.name||'?'}</td><td>${m.score}</td><td>${m.matchRating}</td>`;
        const topTd=document.createElement('td');
        const ps=m.playersStats||{};
        // grupowanie po teamach
        const arrA=[], arrB=[];
        Object.entries(ps).forEach(([pid,st])=>{
          // musimy sprawdzić do której drużyny należy - zakładamy że jesteśmy
          // prosto: profesjonaliści powinni trzymać mapę pid→tid - tu robimy brute-force:
          const tid=(m.teamA && playersData && playersData[pid])?m.teamA:
                   (m.teamB)?m.teamB:'';
          const arr = tid===m.teamA?arrA:arrB;
          arr.push({ pid, score: st.score });
        });
        const sort3 = a=>a.sort((x,y)=>y.score - x.score).slice(0,3).map(x=> (playersData[x.pid]?.name||'?') + ` (${x.score.toFixed(1)})`);
        topTd.textContent = 'A: '+sort3(arrA).join(', ') + '; B: '+sort3(arrB).join(', ');
        tr.appendChild(topTd);

        const actionTd=document.createElement('td');
        const del=document.createElement('button');
        del.textContent='Usuń';
        del.style.backgroundColor='#cc3333';
        del.onclick=()=>{
          if(confirm('Usunąć mecz?')) db.ref(`matches/${mid}`).remove().then(loadMatches);
        };
        actionTd.append(del);
        tr.appendChild(actionTd);
        matchesTableBody.appendChild(tr);
      }
    });
  }

  // POSTĘP
  function loadTeamsForChart(){
    db.ref('teams').once('value').then(snap=>{
      teamsData=snap.val()||{};
      chartTeamSelect.innerHTML='';
      for(const id in teamsData){
        const opt=document.createElement('option');
        opt.value=id; opt.textContent=teamsData[id].name;
        chartTeamSelect.appendChild(opt);
      }
      if(chartTeamSelect.options.length>0){ chartTeamSelect.value=chartTeamSelect.options[0].value; loadCharts(chartTeamSelect.value); }
    });
  }

  chartTeamSelect.addEventListener('change', ()=>loadCharts(chartTeamSelect.value));

  function loadCharts(teamId){
    db.ref(`players/${teamId}`).once('value').then(snap=>{
      const pd=snap.val()||{};
      const labels=[], tAvg=[], mAvg=[];
      for(const pid in pd){
        labels.push(pd[pid].name);
        const ts=Object.values(pd[pid].trainingScores||{}).map(Number);
        const ms=Object.values(pd[pid].matchScores||{}).map(Number);
        const ta=ts.length?ts.reduce((a,b)=>a+b)/ts.length:0;
        const ma=ms.length?ms.reduce((a,b)=>a+b)/ms.length:0;
        tAvg.push(ta.toFixed(2));
        mAvg.push(ma.toFixed(2));
      }
      if(trainingChart) trainingChart.destroy();
      if(matchChart) matchChart.destroy();
      trainingChart=new Chart(trainingChartCanvas.getContext('2d'),{
        type:'bar', data:{labels, datasets:[{label:'Śr. trening', data:tAvg, backgroundColor:'#003366'}]},
        options:{scales:{y:{beginAtZero:true, max:10}}}
      });
      matchChart=new Chart(matchChartCanvas.getContext('2d'),{
        type:'bar', data:{labels, datasets:[{label:'Śr. mecz', data:mAvg, backgroundColor:'#0055aa'}]},
        options:{scales:{y:{beginAtZero:true, max:10}}}
      });
    });
  }

   
  function resetUI(){
    teamsList.innerHTML = '';
    playersList.innerHTML = '';
    matchesTableBody.innerHTML = '';
    teamDetails.classList.add('hidden');
    playerDetails.classList.add('hidden');
    playerStatsContainer.innerHTML = '';
    teamASelect.innerHTML = '';
    teamBSelect.innerHTML = '';
    chartTeamSelect.innerHTML = '';
    if (trainingChart) trainingChart.destroy();
    if (matchChart) matchChart.destroy();
  }
</script>

</body>
</html>
